<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Bakery Order</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg: #fdf6ec;
        --card: #ffffff;
        --primary: #c68642;
        --primary-hover: #b87736;
        --border: #e6d8c3;
        --text: #3d2f1e;
        --shadow-focus: 0 0 0 4px rgba(198, 134, 66, 0.25);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 2rem;
      }

      h2 {
        margin-top: 0;
        text-align: center;
      }

      h3 {
        margin-top: 24px;
        text-align: left;
      }

      form {
        background: var(--card);
        padding: 2rem;
        border-radius: 16px;
        max-width: 720px;
        margin: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      }

      label {
        display: block;
        margin-top: 1rem;
        font-weight: 500;
      }

      input,
      select {
        margin-top: 0.4rem;
        width: 100%;
        padding: 0.65rem 0.75rem;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 0.95rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
        background-color: #fff;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--shadow-focus);
      }

      .row {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.75rem;
        align-items: flex-end;
      }

      .row select {
        flex: 2;
      }

      .row input[type="number"] {
        flex: 1;
      }

      button {
        border-radius: 12px;
        border: none;
        padding: 0.65rem 1rem;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.05s ease;
      }

      button:hover {
        transform: translateY(-1px);
      }

      button:active {
        transform: translateY(0);
      }

      button[type="submit"],
      .add-btn {
        background: var(--primary);
        color: white;
      }

      button[type="submit"]:hover,
      .add-btn:hover {
        background: var(--primary-hover);
      }

      .add-article {
        margin-top: 12px;
      }

      .remove-btn {
        background: #fdecea;
        color: #b91c1c;
        border: 1px solid #f5c2c2;
        padding: 0.55rem 0.7rem;
      }

      .remove-btn:hover {
        background: #fbd5d5;
      }

      .total {
        margin-top: 1.5rem;
        font-size: 1.2rem;
        font-weight: 600;
        text-align: right;
      }

      .success {
        margin-top: 1rem;
        color: #2f7a3e;
        font-weight: 500;
      }

      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      #items.hidden {
        display: none;
      }

      .loading-spinner.hidden {
        display: none;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      button:disabled:hover {
        transform: none;
      }

      button[type="submit"].loading {
        position: relative;
        color: transparent;
      }

      button[type="submit"].loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal {
        background: var(--card);
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text);
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: background 0.2s ease;
      }

      .modal-close:hover {
        background: var(--border);
      }

      .modal-content {
        margin-bottom: 1.5rem;
      }

      .modal-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border);
      }

      .modal-item:last-child {
        border-bottom: none;
      }

      .modal-footer {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .modal-btn {
        padding: 0.65rem 1.5rem;
      }

      .modal-btn-secondary {
        background: var(--border);
        color: var(--text);
      }

      .modal-btn-secondary:hover {
        background: #d4c5b0;
      }

      @media (max-width: 600px) {
        .row {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <h2>ðŸ¥– Bakery Order Form</h2>

    <form id="orderForm">
      <label>
        First name
        <input type="text" id="firstName" required />
      </label>

      <label>
        Last name
        <input type="text" id="lastName" required />
      </label>

      <label>
        Phone number
        <input type="tel" id="phone" required />
      </label>

      <label>
        Email (optional)
        <input type="email" id="email" />
      </label>

      <label>
        Location
        <select id="location" required>
          <option value="">Select location</option>
          <option value="subotica">Subotica</option>
          <option value="hajdukovo">Hajdukovo</option>
        </select>
      </label>

      <h3>Ordered bread</h3>

      <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div id="items" class="hidden"></div>

      <button type="button" class="add-article" onclick="addItem()">
        âž• Add bread
      </button>

      <div class="total">Total price: <span id="totalPrice">0</span> RSD</div>

      <button type="submit" style="margin-top: 1rem">Submit order</button>

      <div id="result" class="success"></div>
    </form>

    <div id="confirmationModal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Confirm Order</h3>
          <button type="button" class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-content" id="modalContent"></div>
        <div class="modal-footer">
          <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal()">
            Cancel
          </button>
          <button type="button" class="modal-btn" onclick="confirmOrder()">
            Confirm Order
          </button>
        </div>
      </div>
    </div>

    <script>
      const BREAD_TYPES_URL = "https://n8n.aleksthecoder.com/webhook/bread-types";
      const ORDER_SUBMIT_URL = "https://n8n.aleksthecoder.com/webhook/bakery-order";

      // Form element selectors (global variables for DRY principle)
      const firstNameEl = document.getElementById('firstName');
      const lastNameEl = document.getElementById('lastName');
      const phoneEl = document.getElementById('phone');
      const emailEl = document.getElementById('email');
      const locationEl = document.getElementById('location');

      let breadTypes = [
        { id: "white_500", name: "White bread 500g", price: 120 },
        { id: "rye_700", name: "Rye bread 700g", price: 180 },
      ];

      /**
       * Example fallback data if fetch fails
       */
      const fallbackBreadTypes = [
        { id: "white_500", name: "White bread 500g", price: 120 },
        { id: "rye_700", name: "Rye bread 700g", price: 180 },
      ];

      async function loadBreadTypes() {
        try {
          const res = await fetch(BREAD_TYPES_URL);
          const breadTypesResponse = await res.json();
          breadTypes = breadTypesResponse.data;

        } catch {
          breadTypes = fallbackBreadTypes;
        }
      }

      function addItem() {
        const container = document.getElementById("items");

        const row = document.createElement("div");
        row.className = "row";

        const select = document.createElement("select");
        breadTypes.forEach((b) => {
          const opt = document.createElement("option");
          opt.value = b.id;
          opt.dataset.price = b.price;
          opt.textContent = `${b.name} (${b.price} RSD)`;
          select.appendChild(opt);
        });

        const qty = document.createElement("input");
        qty.type = "number";
        qty.min = 1;
        qty.value = 1;

        const remove = document.createElement("button");
        remove.type = "button";
        remove.textContent = "âœ–";
        remove.className = "remove-btn";
        remove.onclick = () => {
          row.remove();
          calculateTotal();
          updateSubmitButtonState();
        };

        select.onchange = () => {
          calculateTotal();
          updateSubmitButtonState();
        };
        qty.oninput = () => {
          calculateTotal();
          updateSubmitButtonState();
        };

        row.append(select, qty, remove);
        container.appendChild(row);

        calculateTotal();
        updateSubmitButtonState();
      }

      function calculateTotal() {
        let total = 0;

        document.querySelectorAll("#items .row").forEach((row) => {
          const select = row.querySelector("select");
          const qty = row.querySelector("input");
          const price = Number(select.selectedOptions[0].dataset.price);
          total += price * Number(qty.value || 0);
        });

        document.getElementById("totalPrice").textContent = total;
        updateSubmitButtonState();
      }

      function updateSubmitButtonState() {
        const submitBtn = document.querySelector('button[type="submit"]');
        const itemCount = document.querySelectorAll("#items .row").length;
        submitBtn.disabled = itemCount === 0;
      }

      function showConfirmationModal(orderData) {
        const modal = document.getElementById("confirmationModal");
        const content = document.getElementById("modalContent");
        
        const locationNames = {
          subotica: 'Subotica',
          hajdukovo: 'Hajdukovo'
        };
        
        let html = `
          <div style="margin-bottom: 1rem;">
            <strong>Customer:</strong><br>
            ${orderData.customer.firstName} ${orderData.customer.lastName}<br>
            ${orderData.customer.phone}
            ${orderData.customer.email ? `<br>${orderData.customer.email}` : ''}
            ${orderData.location ? `<br><br><strong>Location:</strong> ${locationNames[orderData.location] || orderData.location}` : ''}
          </div>
          <div style="margin-bottom: 1rem;">
            <strong>Order Items:</strong>
        `;
        
        orderData.items.forEach((item) => {
          html += `
            <div class="modal-item">
              ${item.breadName} Ã— ${item.quantity} = ${item.total} RSD
            </div>
          `;
        });
        
        html += `
          </div>
          <div style="font-size: 1.2rem; font-weight: 600; text-align: right; padding-top: 1rem; border-top: 2px solid var(--border);">
            Total: ${orderData.totalPrice} RSD
          </div>
        `;
        
        content.innerHTML = html;
        modal.classList.add("show");
      }

      function closeModal() {
        document.getElementById("confirmationModal").classList.remove("show");
      }

      let pendingOrderData = null;

      async function confirmOrder() {
        if (!pendingOrderData) return;
        
        const submitBtn = document.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.classList.add("loading");
        submitBtn.textContent = "Submitting...";

        try {
          const res = await fetch(ORDER_SUBMIT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(pendingOrderData),
          });

          if (res.ok) {
            closeModal();
            
            // Save user data before resetting
            const savedUserData = {
              firstName: firstNameEl.value,
              lastName: lastNameEl.value,
              phone: phoneEl.value,
              email: emailEl.value,
              location: locationEl.value
            };
            
            // Reset form (clears all fields)
            orderForm.reset();
            
            // Restore user data
            firstNameEl.value = savedUserData.firstName;
            lastNameEl.value = savedUserData.lastName;
            phoneEl.value = savedUserData.phone;
            emailEl.value = savedUserData.email;
            locationEl.value = savedUserData.location;
            
            // Clear order items and add new item
            const itemsDiv = document.getElementById("items");
            itemsDiv.innerHTML = "";
            addItem();
            document.getElementById("result").textContent =
              "âœ… Order submitted successfully!";
            calculateTotal();
          } else {
            alert("Failed to submit order. Please try again.");
          }
        } catch (error) {
          alert("An error occurred. Please try again.");
        } finally {
          submitBtn.disabled = false;
          submitBtn.classList.remove("loading");
          submitBtn.textContent = "Submit order";
          pendingOrderData = null;
        }
      }

      document
        .getElementById("orderForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const items = [...document.querySelectorAll("#items .row")].map(
            (row) => {
              const select = row.querySelector("select");
              const qty = Number(row.querySelector("input").value);
              const bread = breadTypes.find((b) => b.id === select.value);

              return {
                breadId: bread.id,
                breadName: bread.name,
                quantity: qty,
                unitPrice: bread.price,
                total: bread.price * qty,
              };
            }
          );

          const payload = {
            customer: {
              firstName: firstName.value,
              lastName: lastName.value,
              phone: phone.value,
              email: email.value || null,
            },
            items,
            totalPrice: Number(totalPrice.textContent),
            submittedAt: new Date().toISOString(),
            location: document.getElementById('location').value,
          };

          // Save customer info to localStorage
          const customerInfo = {
            firstName: firstNameEl.value,
            lastName: lastNameEl.value,
            email: emailEl.value || '',
            phone: phoneEl.value,
            location: locationEl.value
          };
          localStorage.setItem('bakery-order', JSON.stringify(customerInfo));


          pendingOrderData = payload;
          showConfirmationModal(payload);
        });

      function loadCustomerInfoFromStorage() {
        const stored = localStorage.getItem('bakery-order');
        if (stored) {
          try {
            const customerInfo = JSON.parse(stored);
            
            if (customerInfo.firstName) {
              firstNameEl.value = customerInfo.firstName;
            }
            
            if (customerInfo.lastName) {
              lastNameEl.value = customerInfo.lastName;
            }
            
            if (customerInfo.email) {
              emailEl.value = customerInfo.email;
            }
            
            if (customerInfo.phone) {
              phoneEl.value = customerInfo.phone;
            }
            
            if (customerInfo.location) {
              locationEl.value = customerInfo.location;
            }
          } catch (error) {
            console.error('Error loading customer info from localStorage:', error);
          }
        }
      }

      (async function init() {
        await loadBreadTypes();
        document.getElementById("loadingSpinner").classList.add("hidden");
        document.getElementById("items").classList.remove("hidden");
        loadCustomerInfoFromStorage();
        addItem();
        updateSubmitButtonState();
      })();
    </script>
  </body>
</html>
